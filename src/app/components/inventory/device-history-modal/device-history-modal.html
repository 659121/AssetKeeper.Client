@if (visible) {
  <div class="modal-overlay" (click)="onOverlayClick($event)">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</h3>
        <button (click)="onCancel()" class="btn-close">√ó</button>
      </div>
      <div class="modal-body">
        @if (device) {
          <div class="device-info">
            <strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> {{ device.name }} ({{ device.inventoryNumber }})
            @if (device.currentDepartmentName) {
              <br><strong>–¢–µ–∫—É—â–∏–π –æ—Ç–¥–µ–ª:</strong> {{ device.currentDepartmentName }}
            }
          </div>

          @if (loading) {
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
          } @else if (history.length === 0) {
            <div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>
          } @else {
            <div class="history-list">
              @for (item of history; track item.id) {
                <div class="history-item">
                  <div class="history-header">
                    <span class="history-date">
                      {{ formatDate(item.movedAt) }}
                    </span>
                    
                    <!-- –ë–ª–æ–∫ —Å –ø—Ä–∏—á–∏–Ω–æ–π –∏ –∫–Ω–æ–ø–∫–æ–π –ø–µ—á–∞—Ç–∏ -->
                    <div class="history-actions">
                      @if (item.reasonName) {
                        <span class="history-reason">
                          {{ item.reasonName }}
                        </span>
                      }

                      <!-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–∏ 'User' –∏–ª–∏ 'Admin' –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∫–Ω–æ–ø–æ–∫ -->
                      @if (authService.hasAnyRole(['User', 'Admin'])) {
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ "–ê–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏" -->
                        @if (item.reasonCode === 'repair' || item.reasonCode === 'return') {
                          <button 
                            class="btn-print-history" 
                            (click)="onPrintTransfer(item)" 
                            title="–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∞–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏">
                            üìÑ –ê–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏
                          </button>
                        }

                        <!-- –ö–Ω–æ–ø–∫–∞ "–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫" -->
                        @if (item.reasonCode === 'return') {
                          <button 
                            class="btn-print-history pass-btn" 
                            (click)="onPrintPass(item)" 
                            title="–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫">
                            üé´ –ú–∞—Ç. –ø—Ä–æ–ø—É—Å–∫
                          </button>
                        }

                      }
                    </div>
                  </div>
                  
                  <div class="history-details">
                    <div class="history-row">
                      <span class="history-label">–û—Ç–¥–µ–ª:</span>
                      <span class="history-value">
                        @if (item.fromDepartmentName) {
                          {{ item.fromDepartmentName }} ‚Üí 
                        }
                        {{ item.toDepartmentName || '–ù–µ —É–∫–∞–∑–∞–Ω' }}
                      </span>
                    </div>
                    
                    @if (item.movedBy) {
                      <div class="history-row">
                        <span class="history-label">–ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª:</span>
                        <span class="history-value">{{ item.movedBy }}</span>
                      </div>
                    }

                    <!-- –ü–æ–ª–µ —Å—Ç–∏–∫–µ—Ä–∞ -->
                    <div class="history-row">
                      <span class="history-label">–°—Ç–∏–∫–µ—Ä:</span>
                      <span class="history-value">
                        @if (item.oldSticker !== item.newSticker) {
                          @if (item.oldSticker !== null) {
                            {{ item.oldSticker }} ‚Üí 
                          }
                          {{ item.newSticker || '–ù–µ —É–∫–∞–∑–∞–Ω' }}
                        } @else {
                          {{ item.newSticker || '–ù–µ —É–∫–∞–∑–∞–Ω' }}
                        }
                      </span>
                    </div>
                    
                    @if (item.note) {
                      <div class="history-row">
                        <span class="history-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</span>
                        <span class="history-value">{{ item.note }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
      <div class="modal-footer">
        <button (click)="onCancel()" class="btn-cancel">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
}