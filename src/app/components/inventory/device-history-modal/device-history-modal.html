@if (visible) {
  <div class="modal-overlay" (click)="onOverlayClick($event)">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>История перемещений</h3>
        <button (click)="onCancel()" class="btn-close">×</button>
      </div>
      <div class="modal-body">
        @if (device) {
          <div class="device-info">
            <strong>Устройство:</strong> {{ device.name }} ({{ device.inventoryNumber }})
            @if (device.currentDepartmentName) {
              <br><strong>Текущий отдел:</strong> {{ device.currentDepartmentName }}
            }
          </div>

          @if (loading) {
            <div class="loading">Загрузка истории...</div>
          } @else if (history.length === 0) {
            <div class="empty-state">История перемещений отсутствует</div>
          } @else {
            <div class="history-list">
              @for (item of history; track item.id) {
                <div class="history-item">
                  <div class="history-header">
                    <span class="history-date">
                      {{ formatDate(item.movedAt) }}
                    </span>
                    @if (item.reasonName) {
                      <span class="history-reason">
                        {{ item.reasonName }}
                      </span>
                    }
                  </div>
                  
                  <div class="history-details">
                    <div class="history-row">
                      <span class="history-label">Отдел:</span>
                      <span class="history-value">
                        @if (item.fromDepartmentName) {
                          {{ item.fromDepartmentName }} → 
                        }
                        {{ item.toDepartmentName || 'Не указан' }}
                      </span>
                    </div>
                    
                    @if (item.movedBy) {
                      <div class="history-row">
                        <span class="history-label">Переместил:</span>
                        <span class="history-value">{{ item.movedBy }}</span>
                      </div>
                    }

                    @if (item.oldSticker !== null || item.newSticker !== null) {
                      <div class="history-row">
                        <span class="history-label">Стикер:</span>
                        <span class="history-value">
                          @if (item.oldSticker !== null) {
                            {{ item.oldSticker }} →
                          }
                          {{ item.newSticker || 'Не указан' }}
                        </span>
                      </div>
                    }
                    
                    @if (item.note) {
                      <div class="history-row">
                        <span class="history-label">Примечание:</span>
                        <span class="history-value">{{ item.note }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        }
      </div>
      <div class="modal-footer">
        <button (click)="onCancel()" class="btn-cancel">Закрыть</button>
      </div>
    </div>
  </div>
}